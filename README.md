## ボーン制御 for AviUtl2

AviUtl2 向けの一般用途ボーン制御スクリプトです。親子関係（P2/C2）による位置・回転・倍率・縦横比の継承、および子→親の連鎖（Emit）に対応します。

### 特長
- **親子継承（P2/C2）**: 位置・回転(X/Y/Z)・倍率(zoom)・縦横比(aspect)を継承します
- **連鎖（Emit）**: 子オブジェクトの最終変換を新しい親として登録し、多段の追従を実現します
- **倍率合成の分離**: 子倍率は `obj.zoom`、親倍率は `drawpoly` 頂点サイズ側で適用。二重適用を防止します
- **縦横比の継承**: 非等方スケール(sx/sy)を維持しつつ、`drawpoly` による見た目の縦横比継承を行います

---

## インストール
1) AviUtl2 のスクリプトフォルダ（例: `C:\ProgramData\aviutl2\Script\`）に、以下の2ファイルを配置してください。
```
@ボーン制御2.anm
bokuju_parent_control2.lua
```
2) AviUtl2 を起動します。
3) オブジェクトへのエフェクト追加のアニメーション効果に表示されていれば導入成功です。


## 使い方（基本）
初代Aviutlでボーン制御プラグインを利用していた人は直感的にわかると思います。
思うがままに操作してください。

### 親の設定（P2）
1) 親にしたいオブジェクトへエフェクト「`P2(Parent)@ボーン制御2`」を追加
2) `ParentId` に 1〜100 の任意の数値を設定（親の識別子になります）
3) 必要に応じて `HideSelf` を 1 にすると、親オブジェクトの見た目を非表示にできます

### 子の設定（C2）
1) 子にしたいオブジェクトへエフェクト「`C2(Child)@ボーン制御2`」を追加
2) `ParentId` に追従先の親 ID を設定（P2 の `ParentId` と一致させる）
3) オプションチェック:
   - `InheritRotation` 回転を継承します
   - `InheritAspect` 親の縦横比を見た目で継承します
   - `InheritCenter` 中心（ピボット）。実験的/未確定、後述の制約を参照

### 連鎖（Emit）
子オブジェクトの最終変換を新しい親として公開できます。
- `EmitParentId` に 1〜100 の ID を指定すると、子の最終状態がその ID の「親」として登録されます
- 以降のオブジェクトは `ParentId=EmitParentId` を指定することで、子→親→孫…の多段追従が可能です

### 直列連鎖の設計（最小構成）
- **基本方針**: 直列の連鎖では、P2 はチェーンの起点だけに付与し、以降は C2 に `EmitParentId` を設定して次段の「親ID」に橋渡しします。
  - 起点: `P2(Parent)` で `ParentId=n` を登録
  - 中間: `C2(Child)` で `ParentId=前段ID`、`EmitParentId=次段ID`
  - 終端: `C2(Child)` で `ParentId=直前のEmit ID`
 
つまり、**直列連鎖させる場合はP2(parent)は1つ**です。

- **設定例（4段・各90°回転で合計360°）**
  1) オブジェクト1（起点の親）
     - 追加: `P2(Parent)`、`ParentId=1`
     - 回転: 例 `rz=+90°`
  2) オブジェクト2（子→親をEmit）
     - 追加: `C2(Child)`、`ParentId=1`、`EmitParentId=2`、`InheritRotation=ON`
     - 回転: 例 `rz=+90°`
  3) オブジェクト3（孫→親をEmit）
     - 追加: `C2(Child)`、`ParentId=2`、`EmitParentId=3`、`InheritRotation=ON`
     - 回転: 例 `rz=+90°`
  4) オブジェクト4（ひ孫・終端）
     - 追加: `C2(Child)`、`ParentId=3`、`InheritRotation=ON`
     - 回転: 例 `rz=+90°`（合成結果は360°=1回転）

- **注意点**
  - **レイヤー順**: 安定のため「親 → 子 → 孫 → ひ孫」の順で上から配置を推奨
  - **軸の統一**: 4つとも同一軸（例: Z）で 90°。軸が混在するとオイラー合成の非可換性で結果が変わります
  - **見え方**: 360°は姿勢としては0°と同等（1回転）。UI上で0°相当に見えるのは正常です

- **例外（複数のP2が有効な場面）**
  - 独立した複数ルートがある場合（各ルートの起点ごとにP2が必要）
  - 中間ノードを他オブジェクトから「直接参照する親」にしたい場合
    - 原則は中間C2の `EmitParentId` で登録したIDを他から `ParentId` に指定すればP2は不要です
    - ただし P2 固有のUI（例: `HideSelf`）を中間でも使いたい等の事情があれば、中間にP2を追加しても構いません
---

## 実装仕様の要点
- **倍率合成（分離）**
  - 子倍率: `obj.zoom = 子プロパティ × 子トラック`
  - 親倍率: `drawpoly` の四隅寸法にのみ乗算（見た目側で適用）
  - これにより、子→親→孫の連鎖でも二重拡大が起きません
- **縦横比の継承**
  - 親の `aspect` を `sx/sy` に変換し、四隅を非等方スケールして描画
  - `obj.setoption("sampler","clamp")` を使用し、テクスチャ外参照で欠けないようにしています
- **回転合成**
  - `r2_P_C_ROTATION` で子→親の順に合成（オイラー方位の重ね合わせ）
  - 子トラック角を差し引く形で適用し、二重適用を回避

---

## 既知の制約・未実装
一般的なボーン制御は機能していますが、親子関係を表示するデバッグ機能などが上手く機能していません。
通常の利用では問題ないはずです。

### 認識している不具合
- **急に追従しなくなる**：: オブジェクトの追加等をトリガーとして発生します。プロジェクトを保存し、Aviutl2を再起動すると再起動すると解消します。
- **DebugDisp（デバッグ描画）**: オブジェクト上にp1等を表示するデバッグ文字描画を無効化しています。
  - ログ出力は継続可能です。エラーチェックを行う際はログ表示から確認してください。
- **中心（cx/cy/cz）の継承**: AviUtl2 の実装差異により正確な追従は未確定。`InheritCenter` は実験的な挙動です


## ログ解析
- リボンの表示-->ログ表示で動作が確認できます。
- エラーの報告時はこれを出力したものを合わせてください。


## 備考
- 作者: 墨汁
- X:@theisumania
- 本ReadmeはCursor GPT5に書かせたものを私が加筆修正したものです。
- 参考: rikky氏のAviUtl向け既存実装を参考にもとに、CursorとGPT5を用いてAviUtl2 の API 仕様へ移植しています

不具合・要望は ログを添えてIssue にお願いします。


